---
- hosts: all
  gather_facts: yes
  become: yes
  tasks:

  - name: Ensure directory exists
    file:
      path: "/home/robo/docker-volumes/playbook"
      state: directory

  - name: Clone Git repository
    git:
      repo: 'https://github.com/unord/rpa-stacks.git'
      dest: "/home/robo/docker-volumes/playbook"
    ignore_errors: yes

  - name: Authenticate with Portainer API
    uri:
      url: "http://10.18.225.150:9000/api/auth"
      method: POST
      body_format: json
      body: '{"Username": "{{ ansible_user }}", "Password": "{{ ansible_sudo_pass }}"}'
      return_content: yes
      status_code: 200
    register: portainer_auth_result

  - name: Create a stack for each .yml file in a directory
    become: yes
    uri:
      url: "http://10.18.225.150:9000/api/endpoints/{{ endpoint_id }}/stacks?type=1"
      method: POST
      body_format: json
      headers:
        Authorization: "Bearer {{ portainer_jwt }}"
      body:
        {
          "Name": "{{ item | basename | regex_replace('\\.yml$', '') }}",
          "StackFileContent": "{{ lookup('file', item) }}"
        }
      return_content: yes
      status_code: 201
    with_fileglob:
      - "/github-repo/*.yml"
